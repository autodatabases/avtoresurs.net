{% extends 'main/base.html' %}
{% load staticfiles %}

{% block custom_css %}
    <link rel="stylesheet" href='{% static "main/css/generalcatalogs.css" %}'>

    <style>
        .slider {
            -webkit-appearance: none;
        {#            width: 100%;#} height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #1F3EFC;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #1F3EFC;
            cursor: pointer;
        }
    </style>

{% endblock %}
{% block title %}{{ object.title }}{% endblock title %}

{% block breadcrumbs %}
    <!-- BREADCRUMBS -->
    <nav aria-label="breadcrumb" role="navigation">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Главная</a></li>
            <li class="breadcrumb-item"><a href="{% url 'shop:shop_index' %}">Интернет-магазин</a></li>
            <li class="breadcrumb-item"><a href="">{{ product.title }} {{ product|upper }}</a></li>
        </ol>
    </nav>

{% endblock %}

{% block content %}

    <!-- Main content -->
    <div class="row">
        <div class="col-xs-12 col-sm-4 left">
            <img src="/static/main/images/no-image.png" class="img-fluid tovar" alt="Responsive image"
                 id="product-image">
            <!-- Button trigger modal -->
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#techModal">
                Характеристики
            </button>
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#applicabilityModal">
                Применимость
            </button>

        </div>

        <div class="col-xs-12 col-sm-6 right">
            <form method="POST" action="{% url 'cart' %}" id="add-form">

                <div class="row product-desc text-center">
                    <div class="col-5"><p class="text">Производитель</p></div>
                    <div class="col-2"><p class="text">&mdash;</p></div>
                    <div class="col-5"><p class="text text-avtoresurs">{{ product.brand|upper }}</p></div>
                </div>
                <div class="row product-desc text-center">
                    <div class="col-5"><p class="text">Наименование</p></div>
                    <div class="col-2"><p class="text">&mdash;</p></div>
                    <div class="col-5"><p class="text text-avtoresurs">{{ product.title|upper }}</p></div>
                </div>
                <div class="row product-desc text-center">
                    <div class="col-5"><p class="text">Код детали</p></div>
                    <div class="col-2"><p class="text">&mdash;</p></div>
                    <div class="col-5"><p class="text">{{ product.get_sku|upper }}</p></div>
                </div>
                <div class="row product-desc text-center">
                    <div class="col-5"><p class="text">Цена розничная</p></div>
                    <div class="col-2"><p class="text">&mdash;</p></div>
                    <div class="col-5"><p class="text">{{ product.retail_price }}</p></div>
                </div>
                <div class="row product-desc text-center">
                    <div class="col-5"><p class="text">Цена оптовая</p></div>
                    <div class="col-2"><p class="text">&mdash;</p></div>
                    <div class="col-5"><p class="text">{{ product.whosale_price }}</p></div>
                </div>


                <div class="line3">НАЛИЧИЕ НА СКЛАДЕ:</div>

                {% for storage in storages %}
                    <div class="row product-desc text-center">
                        <div class="col-5">

                            <p class="text">{{ storage }}</p>
                            <input class="with-gap" name="product_price" type="hidden"
                                   id="product_price{{ storage.id }}" value="{{ storage.product_price.id }}">
                        </div>
                        <div class="col-1">
                            <p id="storageqty{{ storage.id }}"></p>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <div class="slidecontainer">
                                    <span>0</span>
                                    <input type="range" min="0" max="{{ storage.product_price.quantity }}" value="0"
                                           class="slider"
                                           id="storageslider{{ storage.id }}"
                                            {% if storage.product_price.quantity == 0 %} disabled{% endif %}>
                                    <span>{{ storage.product_price.quantity }}</span>
                                </div>

                                {#                                {% if storage.product_price.quantity > 0 %}#}
                                {#                                    <select class="form-control custom-select" id="country"#}
                                {#                                            name="storage{{ storage.id }}">#}
                                {#                                        <option value="0">0</option>#}
                                {#                                        {% for i in storage.quantity %}#}
                                {#                                            <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>#}
                                {#                                        {% endfor %}#}
                                {#                                    </select>#}
                                {#                                {% else %}#}
                                {#                                    <select class="form-control custom-select" id="country" disabled>#}
                                {#                                        <option>0</option>#}
                                {#                                    </select>#}
                                {#                                {% endif %}#}


                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div class="row sklad">
                    <div class="col-12">
                        <input type="hidden" name="item" value="{{ object.id }}">
                        <button class="btn btn-primary" id="submit-btn">В корзину</button>
                    </div>
                </div>

            </form>

        </div>
    </div>

    <table class="table table-hover table-avtoresurs">
        <thead class="thead-light">
        <tr>
            <th scope="col">#</th>
            <th scope="col">Артикул</th>
            <th scope="col">Производитель</th>
            <th scope="col">Название</th>
            <th scope="col">Кол-во</th>
            <th scope="col">Цена</th>
        </tr>
        </thead>
        <tbody>
        {% for part_analog in part_analogs %}
            <tr class="table-light">
                <th scope="row">
                    {% if part_analog.product_id %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            {{ forloop.counter }}
                        </a>
                    {% else %}
                        {{ forloop.counter }}
                    {% endif %}
                </th>
                <td>
                    {% if part_analog.product_id %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            {{ part_analog.part_number }}
                        </a>
                    {% else %}
                        {{ part_analog.part_number }}
                    {% endif %}

                </td>
                <td>
                    {% if part_analog.product_id %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            {{ part_analog.supplier }}
                        </a>
                    {% else %}
                        {{ part_analog.supplier }}
                    {% endif %}
                </td>
                <td>
                    {% if part_analog.product_id %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            {{ part_analog.title }} {{ part_analog.supplier }} {{ part_analog.part_number }}
                        </a>
                    {% else %}
                        {{ part_analog.title }} {{ part_analog.supplier }} {{ part_analog.part_number }}
                    {% endif %}
                </td>
                <td>
                    {% if part_analog.quantity > -1 %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            <strong>{{ part_analog.quantity }}</strong>
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if part_analog.price > -1 %}
                        <a href="{% url 'shop:product_detail' part_analog.product_id %}">
                            <strong>{{ part_analog.price }}</strong>
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Modal TECH CHARACTERISTIC -->
    <div class="modal fade" id="techModal" tabindex="-1" role="dialog" aria-labelledby="techModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="techModalLabel">Изделие {{ product.title }} {{ product|upper }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% if product.get_part_attributes %}
                        {% for pa in product.get_part_attributes %}
                            <p>{{ pa.displaytitle }}: <strong>{{ pa.displayvalue }}</strong></p>
                        {% endfor %}
                    {% else %}
                        <p>Описание отсутствует</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Applicability -->
    <div class="modal fade" id="applicabilityModal" tabindex="-1" role="dialog"
         aria-labelledby="applicabilityModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="applicabilityModalLabel">
                        Изделие {{ product.title }} {{ product|upper }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    {% if product.get_part_applicability %}
                        <table class="table table-striped table-avtoresurs">
                            <thead class="thead-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">МАРКА</th>
                                <th scope="col">МОДЕЛЬ</th>
                                <th scope="col">ДАТА ПРОИЗВОДСТВА</th>
                                <th scope="col">ТИП</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for pa in product.get_part_applicability %}
                                <tr class="table-light">
                                    <td>{{ forloop.counter }} </td>
                                    <td>{{ pa.car_type.model.manufacturer.title }} </td>
                                    <td>{{ pa.car_type.model.title }}</td>
                                    <td>{{ pa.car_type.construction_interval }} </td>
                                    <td>{{ pa.car_type.title }}</td>
                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>

                    {% else %}
                        <p>Описание отсутствует</p>
                    {% endif %}


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>

        $('#submit-btn').click(function (event) {
            event.preventDefault();
            var storages = [];
            var product_item = $('input[name="item"]').val();

            $('select[name^="storage"]').each(function () {
                var storage_id = $(this).attr('name').split("storage")[1];
                var product_qty = $(this).val();

                if (product_qty > 0) {
                    var temp_storage = new Object();
                    temp_storage.id = storage_id;
                    temp_storage.qty = product_qty;
                    storages.push(temp_storage);
                }
            });

            cart_product = new Object();
            cart_product.id = product_item;
            cart_product.storages = storages;
            ajax_data = JSON.stringify(cart_product);
            console.log(ajax_data);

            $.ajax({
                type: "POST",
                url: "/cart/",
                contentType: "application/json",
                dataType: "json",
                data: ajax_data,
                success: function (response) {
                    console.log(response);
                    showFlashMessage(response.test);
                    updateCartItemCount();
                },
                error: function (response, error) {
                    console.log(response);
                    console.log(error);
                }
            });
        });

    </script>

    <script>
        $(document).ready(function () {
                $.ajax({
                    url: '{{ product.image }}',
                    type: 'HEAD',
                    error: function () {
                        document.getElementById("product-image").src = '/static/main/images/no-image.png';
                    },
                    success: function () {
                        document.getElementById("product-image").src = '{{ product.image }}';
                    }
                });
            }
        );
    </script>

    <script>
        $(document).ready(function () {
            $('input[type=radio][name=product_price]').change(function () {
                var url = location.protocol + '//' + document.domain + ':' + location.port + '/shop/api/' + this.value + '.json';
                $.getJSON(url, function (data) {
                    qty = data.quantity;
                    retail_price = data.retail_price;
                    whosale_price = data.whosale_price;
                    $('#quantity').text(qty);
                    $('#retail_price').text(retail_price);
                    if (whosale_price) {
                        $('#whosale_price').text(whosale_price);
                    }
                    ;
                });
            });
        });

    </script>

    {% for storage in storages %}
        <script>
            var slider = document.getElementById("storageslider" + {{ storage.id }});
            var output = document.getElementById("storageqty" + {{ storage.id }});
            output.innerHTML = slider.value; // Display the default slider value

            // Update the current slider value (each time you drag the slider handle)
            slider.oninput = function () {
                output.innerHTML = this.value;
            }
        </script>
    {% endfor %}

{% endblock %}